// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./ai_character_council.db"
}

// Define basic models to start with - we'll expand these based on your design
model Project {
  id          String   @id @default(uuid())
  name        String
  description String?
  settings    String?  // JSON string for settings
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  characters    Character[]
  conversations Conversation[]
  timelines     Timeline[]
  notes         Note[]
  tags          Tag[]
}

model Character {
  id               String   @id @default(uuid())
  projectId        String
  name             String
  bio              String?
  personalityTraits String?  // JSON string for traits
  characterSheet   String?  // JSON string for character sheet
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  project              Project                @relation(fields: [projectId], references: [id], onDelete: Cascade)
  conversationMessages ConversationMessage[]
  characterEventLinks  CharacterEventLink[]
  characterMemories    CharacterMemory[]
  characterVersions    CharacterVersion[]

  @@index([projectId])
}

model CharacterMemory {
  id           String   @id @default(uuid())
  characterId  String
  content      String
  importance   Float    @default(0.5)
  embedding    Bytes?   // Stored vector embedding
  metadata     String?  // JSON string for metadata
  timestamp    DateTime @default(now())
  
  character    Character @relation(fields: [characterId], references: [id], onDelete: Cascade)
  
  @@index([characterId])
}

model Conversation {
  id          String   @id @default(uuid())
  projectId   String
  title       String
  summary     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  project     Project               @relation(fields: [projectId], references: [id], onDelete: Cascade)
  messages    ConversationMessage[]

  @@index([projectId])
}

model ConversationMessage {
  id             String   @id @default(uuid())
  conversationId String
  characterId    String?
  role           String   // 'user', 'character', 'system'
  content        String
  metadata       String?  // JSON string for metadata
  timestamp      DateTime @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  character    Character?   @relation(fields: [characterId], references: [id])

  @@index([conversationId])
  @@index([characterId])
}

model Timeline {
  id          String   @id @default(uuid())
  projectId   String
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  project  Project         @relation(fields: [projectId], references: [id], onDelete: Cascade)
  events   TimelineEvent[]

  @@index([projectId])
}

model TimelineEvent {
  id          String   @id @default(uuid())
  timelineId  String
  title       String
  description String?
  date        String   // Flexible date format for fictional timelines
  order       Int      @default(0)
  metadata    String?  // JSON string for metadata
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  timeline           Timeline             @relation(fields: [timelineId], references: [id], onDelete: Cascade)
  characterEventLinks CharacterEventLink[]

  @@index([timelineId])
}

model CharacterEventLink {
  id          String   @id @default(uuid())
  characterId String
  eventId     String
  role        String?  // The character's role in this event
  notes       String?
  createdAt   DateTime @default(now())

  character Character     @relation(fields: [characterId], references: [id], onDelete: Cascade)
  event     TimelineEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@unique([characterId, eventId])
  @@index([characterId])
  @@index([eventId])
}

model CharacterVersion {
  id           String   @id @default(uuid())
  characterId  String
  versionName  String
  data         String   // JSON string for version data
  createdAt    DateTime @default(now())
  
  character    Character @relation(fields: [characterId], references: [id], onDelete: Cascade)
  
  @@index([characterId])
}

model Note {
  id          String   @id @default(uuid())
  projectId   String
  title       String
  content     String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  project     Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
}

model Tag {
  id          String   @id @default(uuid())
  projectId   String
  name        String
  type        String   // e.g., 'symbol', 'theme', 'location', etc.
  color       String?
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  project     Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, name, type])
  @@index([projectId])
}

model UserSettings {
  id                 String   @id @default(uuid())
  theme              String   @default("light")
  llmProvider        String   @default("openai")
  llmModel           String   @default("gpt-4")
  maxMemoriesPerCall Int      @default(10)
  apiKeys            Bytes?   // Encrypted API keys
  lastBackup         DateTime?
  updatedAt          DateTime @updatedAt
}